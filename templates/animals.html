{# animals.html #}

{% extends "base.html" %}

{% block body %}
<div class="container" id="animal-container">
  <div class="row list-actions">
    <div class="span4 offset6">
      <button class="btn">Edit Selected</button>
    </div>
  </div>
</div>

<div>

  <div class="carousel list-row" id="speciesSelector">
    <div class="carousel-scroller">
      <ul data-bind="foreach: species">
        <li data-bind="click: $parent.setCurrentSpecies,
            css: { 'list-active': $parent.currentSpecies() == $data }">
          <div data-bind="text: commonName"></div>
          <div data-bind="text: id"></div>
        </li>
      </ul>
    </div>
  </div>

  <div class="carousel list-row list-items list-items-large" id="animalSelector">
    <div class="carousel-scroller carousel-rows">
      <ul data-bind="foreach: filterAnimalsBySpecies">

        <li data-bind="click: $data.toggleActive,
                       css: { 'list-active': $data.active() == true }">
          <div data-bind="text: name" class="list-title"></div>
          <div data-bind="text: speciesCommonName" class="list-text"></div>
          <div data-bind="text: speciesScientificName" class="list-subtext"></div>
        </li>

      </ul>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{% load coffeescript %}
{{ block.super }}
<script src="{{ STATIC_URL }}script/iscroll.js"></script>
<script src="{{ STATIC_URL }}script/knockout-2.0.0.js"></script>
<script type="text/javascript">
  {% inlinecoffeescript %}
  $(document).ready ->

    # Knockout
    # --------

    class Animal
      constructor: (data) ->
        @active = ko.observable false
        @name = ko.observable data.name
        @speciesScientificName = ko.observable data.species.scientific_name
        @speciesCommonName = ko.observable data.species.common_name
        @speciesId = ko.observable data.species.id
      toggleActive: () ->
        @active !@active()

    class Species
      constructor: (data) ->
        @commonName = ko.observable data.common_name
        @scientificName = ko.observable data.scientific_name
        @id = ko.observable data.id

    class AnimalListViewModel
      constructor: () ->
        # Arrays for holding data
        @species = ko.observableArray []
        @animals = ko.observableArray []

        # Current filter variables
        @currentSpecies = ko.observable ''

        # Apply filters
        @setCurrentSpecies = (species) =>
          if species == @currentSpecies()
            @currentSpecies('')
          else
            @currentSpecies(species)
          resizeAllCarousels()

        # Compute the filtered lists
        @filterAnimalsBySpecies = ko.computed =>
          species = @currentSpecies()
          if species == ''
            return @animals()
          return ko.utils.arrayFilter @animals(), (animal) ->
            return animal.speciesId() == species.id()

        # Get data from API
        $.getJSON '/api/v1/species/?format=json', (data) =>
          mappedSpecies = $.map data.objects, (item) ->
            return new Species item
          @species mappedSpecies

        $.getJSON '/api/v1/animal/?format=json', (data) =>
          mappedAnimals = $.map data.objects, (item) ->
            return new Animal item
          @animals mappedAnimals
          resizeAllCarousels(false)

    ko.applyBindings new AnimalListViewModel()

    # Display
    # -------
    
    MAX_SCROLLER_ROWS = 3
    window.scrollers = {}

    resizeCarousel = (scroller, numRows=1) ->
      oldWidth = $(scroller).width()
      newWidth = Math.ceil($(scroller).find('ul li').length/numRows)*$(scroller).find('ul li:first').outerWidth(true) + 10
      if newWidth != oldWidth
        console.log 'Resizing carousel from ' + oldWidth + ' to ' + newWidth + ' with ' + numRows + ' rows'
        $(scroller).width newWidth
        return true
      return false

    resizeAllCarousels = (refresh=true)->
      $('.carousel-scroller').each ->
        if $(this).hasClass 'carousel-rows'
          numRows = Math.min Math.floor(($(window).height()-$(this).parent().offset().top)/$(this).find('li:first').outerHeight(true)), MAX_SCROLLER_ROWS
          resized = resizeCarousel this, numRows
        else
          resized = resizeCarousel this
        if refresh and resized
          console.log 'Refreshing carousel'
          scrollers[$(this).parent().prop('id')].refresh()

    scrollers.speciesSelector = new iScroll 'speciesSelector', {
      vScroll: false
      momentum: true
      bounce: true
      hScrollbar: false
    }
    scrollers.animalSelector = new iScroll 'animalSelector', {
      vScroll: false
      momentum: true
      bounce: true
      hScrollbar: false
    }

    $(window).resize ->
      clearTimeout window.resizeTimeout
      window.resizeTimeout = setTimeout resizeAllCarousels, 500

  {% endinlinecoffeescript %}
</script>
{% endblock scripts %}
